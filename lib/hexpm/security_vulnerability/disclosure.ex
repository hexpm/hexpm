defmodule Hexpm.SecurityVulnerability.Disclosure do
  use Hexpm.Schema

  @primary_key false
  schema "security_vulnerability_disclosures" do
    field :id, :string
    belongs_to :package, Package
    field :summary, :string
    field :affected, {:array, Hexpm.VersionRequirement}
    field :published_at, :utc_datetime
    field :modified_at, :utc_datetime
    field :details, :map
  end

  def all(package) do
    assoc(package, :security_vulnerability_disclosures)
  end

  def relevant?(%__MODULE__{affected: affected} = _disclosure, %Release{version: version}) do
    Enum.any?(affected, &Version.match?(version, &1))
  end
end
